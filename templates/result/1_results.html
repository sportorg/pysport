{% extends "base.html" %}
{% block title %}Results{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}
<div class="text-center">
    <h3>{{ race.data.description }} <br>{{ race.data.start_datetime|date }} {{ race.data.location }}</h3>
    <h2>ПРОТОКОЛ РЕЗУЛЬТАТОВ</h2>
</div>
<div id="results-tables"></div>
<div>
    <table class="empty-table">
        <tr>
            <td><b>Главный судья:</b></td>
            <td width="150px"></td>
            <td><b>{{ race.data.chief_referee }}</b></td>
        </tr>
        <tr>
            <td><b>Главный секретарь:</b></td>
            <td width="150px"></td>
            <td><b>{{ race.data.secretary }}</b></td>
        </tr>
    </table>
</div>
{% raw %}
<script>
    var race = {% endraw %}{{race|tojson}}{%raw %};
    var selected = {% endraw %}{{selected|tojson}}{%raw %};
    racePreparation(race);

    function getResultsByGroup(group, splitInfo) {
        splitInfo = splitInfo || 'cumulativeTotal';
        var isRelay = group.__type ? group.__type === 3 : race.data.race_type === 3;
        var results = [];
        for (var _i = 0, _a = race.results; _i < _a.length; _i++) {
            var result = _a[_i];
            if (result.status !== 13 && result.person && result.person.group && result.person.group.id === group.id) {
                var r = {
                    index: 0,
                    name: (result.person.surname + ' ' + result.person.name).slice(0, MAX_PERSON_NAME),
                    org: (result.person.organization && String(result.person.organization.name).slice(0, MAX_ORG_NAME)) || '',
                    qual: Qualification[result.person.qual],
                    bib: result.person.bib,
                    year: result.person.birth_date ? (new Date(result.person.birth_date)).getFullYear() : '',
                    penalty_time: toHHMMSS(result.penalty_time),
                    penalty_laps: result.penalty_laps,
                    result: result.result,
                    resultMsec: result.result_msec,
                    diff: toHHMMSS(result.diff),
                    place: result.place,
                    status: result.status,
                    place_show: result.person.is_out_of_competition ? 'в/к' : result.place === 0 ? '' : result.place === -1 ? '' : result.place,
                    speed: result.speed,
                    data: result
                };
                var control_index = 0;
                if (result.splits) {
                    for (var _b = 0, _c = result.splits; _b < _c.length; _b++) {
                        var split = _c[_b];
                        if (split.is_correct) {
                            var info;
                            var place = 0;
                            switch (splitInfo) {
                                case 'cumulativeTotal':
                                    info = toHHMMSS(split.relative_time) + ' (' + split.relative_place + ')';
                                    place = split.relative_place;
                                    break;
                                case 'segment':
                                    info = toHHMMSS(split.leg_time) + ' (' + split.leg_place + ')';
                                    place = split.leg_place;
                                    break;
                            }
                            var span = document.createElement('span');
                            span.className = 'result-' + place;
                            span.appendChild(document.createTextNode(info));
                            r[control_index + '_' + split.code] = span;
                            control_index++;
                        }
                    }
                }
                results.push(r);
            }
        }
        results.sort(function (a, b) {
            if (isRelay) {
                if (a.place < 1) {
                    return 1
                }
                if (b.place < 1) {
                    return -1
                }
                if (isRelay && a.place === b.place) {
                    return ~~(a.bib / 1000) - ~~(b.bib / 1000)
                }
                return a.place - b.place

            } else {
                if (a.status !== 1) {
                    return 1
                }
                if (b.status !== 1) {
                    return -1
                }
                return a.resultMsec - b.resultMsec
            }
        });
        var index = 0;
        if (isRelay) {
            var prevBib = 0;
            var resultsList = results.slice();
            results = [];
            for (var _i = 0, resultsList_ = resultsList; _i < resultsList_.length; _i++) {
                var r = resultsList_[_i];
                r.index = '';
                if (r.bib % 1000 !== prevBib) {
                    index++;
                    results.push({index: index});
                    prevBib = r.bib % 1000;
                }
                results.push(r);
            }
        } else {
            results.forEach(function (elem) {
                index++;
                elem.index = index;
            })
        }
        return results;
    }

    function getRankingByGroup(group) {
        var rankingBlock = document.createElement('span');
        var ranking = group.ranking;
        if (ranking && ranking.is_active) {
            var text = 'Квалификационный уровень (баллы): ' + ranking.rank_scores;
            rankingBlock.appendChild(document.createTextNode(text));

            for (var _i = 0; _i < ranking.rank.length; _i++) {
                var rank = ranking.rank[_i];
                if (rank.is_active) {
                    if (rank.max_place > 0) {
                        var text = Qualification[rank.qual] + ' - до ' + rank.max_place + ' места';
                        rankingBlock.appendChild(document.createElement("br"));
                        rankingBlock.appendChild(document.createTextNode(text));
                    }
                    else {
                        if (rank.max_time > 0) {
                            var text = Qualification[rank.qual] + ' - ' + toHHMMSS(rank.max_time);
                            if (rank.percent > 0) {
                                text += ' (' + rank.percent + '%)';
                            }
                            rankingBlock.appendChild(document.createElement("br"));
                            rankingBlock.appendChild(document.createTextNode(text));
                        }
                    }
                }
            }
        }
        else {
            var text = 'Ранг не подсчитывался';
            rankingBlock.appendChild(document.createTextNode(text));
        }

        return rankingBlock;
    }

    var Fields = {
        localId: 'race_' + race.id + '_result_fields',
        fields: [
            {key: 'index', title: '№'},
            {key: 'name', title: 'Фамилия, имя'},
            {key: 'org', title: 'Коллектив'},
            {key: 'year', title: 'ГР'},
            {key: 'qual', title: 'Разряд'},
            {key: 'bib', title: 'Номер'},
            {key: 'penalty_time', title: 'Штраф', active: false},
            {key: 'penalty_laps', title: 'Штраф', active: false},
            {key: 'result', title: 'Результат'},
            {key: 'diff', title: 'Отставание'},
            {key: 'speed', title: 'Темп', active: false},
            {key: 'place_show', title: 'Место'}
        ],
        active: function (key, val) {
            for (var _i = 0, _a = this.fields; _i < _a.length; _i++) {
                var obj = _a[_i];
                if (key === obj.key) {
                    obj.active = val;
                }
            }
        },
        isActive: function (key) {
            for (var _i = 0, _a = this.fields; _i < _a.length; _i++) {
                var obj = _a[_i];
                if (key === obj.key) {
                    if (obj.active === void 0) {
                        return true;
                    }
                    else {
                        return !!obj.active;
                    }
                }
            }
            return false;
        },
        getCopyFileds: function () {
            return JSON.parse(JSON.stringify(this.fields))
        },
        save: function () {
            if (localStorage) {
                localStorage.setItem(this.localId, JSON.stringify(this.fields));
            }
            return this;
        },
        load: function () {
            try {
                var fields = localStorage ? JSON.parse(localStorage.getItem(this.localId)) : undefined;
                if (fields) {
                    for (var _i = 0, fields_ = fields; _i < fields_.length; _i++) {
                        var f = fields_[_i];
                        this.active(f.key, f.active);
                    }
                }
            } catch (e) {
                console.log(e)
            }
            return this;
        },
        clear: function () {
            if (localStorage) {
                localStorage.clear()
            }
        }
    }.load();

    store = {};

    function render() {
        var resultBlock = document.getElementById('results-tables');
        resultBlock.innerHTML = '';
        for (var _i = 0, _a = race.groups; _i < _a.length; _i++) {
            var group = _a[_i];
            var titleBlock = document.createElement('h2');
            titleBlock.id = group.name;
            titleBlock.appendChild(document.createTextNode(group.name));
            resultBlock.appendChild(titleBlock);
            resultBlock.appendChild(getGroupsBlockElement(race));
            var fields = Fields.getCopyFileds();
            if (store.splitsShow && group.course) {
                group.course.controls.forEach(function (control, index) {
                    fields.push({key: index + '_' + control.code, title: control.code})
                })
            }
            resultBlock.appendChild(new TableGenerator(getResultsByGroup(group, store.splitInfo), fields).getTable({className: 'sportorg-table'}));

            //show ranking information
            if (store.rankingShow) {
                resultBlock.appendChild(getRankingByGroup(group))
            }
        }
        Fields.save();
    }

    render();

    new SettingsGenerator([
        {
            title: 'Номер',
            value: Fields.isActive('bib'),
            change: function (checked) {
                Fields.active('bib', checked);
                render()
            }
        },
        {
            title: 'Штрафное время',
            value: Fields.isActive('penalty_time'),
            change: function (checked) {
                Fields.active('penalty_time', checked);
                render()
            }
        },
        {
            title: 'Кол-во штрафных кругов',
            value: Fields.isActive('penalty_laps'),
            change: function (checked) {
                Fields.active('penalty_laps', checked);
                render()
            }
        },
        {
            title: 'Отставание',
            value: Fields.isActive('diff'),
            change: function (checked) {
                Fields.active('diff', checked);
                render()
            }
        },
        {
            title: 'Темп',
            value: Fields.isActive('speed'),
            change: function (checked) {
                Fields.active('speed', checked);
                render()
            }
        },
        {
            title: 'Сплиты',
            value: false,
            change: function (checked) {
                store.splitsShow = checked;
                render()
            }
        },
        {
            title: 'Выводить ',
            value: [
                {text: 'Нарастающий итог', value: 'cumulativeTotal'},
                {text: 'Отрезок', value: 'segment'}
            ],
            change: function (arr) {
                store.splitInfo = arr[0];
                render();
            }
        },
        {
            title: 'Выполнение',
            value: false,
            change: function (checked) {
                store.rankingShow = checked;
                render()
            }
        },

    ]).show();
</script>
{% endraw %}
{% endblock %}