{% extends "base.html" %}

{% block title %}Results{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% macro view_groups() -%}{% for group in groups %}<a href="#{{group.name}}">{{group.name}}</a> {% endfor %}{%- endmacro %}

{% block content %}
    <div class="text-center">
        <h3>{{ race.sub_title }} <br>{{ race.date }} {{ race.location }}</h3>
        <h2>ПРОТОКОЛ РЕЗУЛЬТАТОВ</h2>
    </div>
    <table class="sportorg-table">
    {% for group in groups %}
    {% if group.persons|length %}
        <tr style="background: white; border: 0">
        <td colspan="7" style="border: 0">
            <h2 id="{{group.name}}">{{ group.name }}{% if group.length %}, {{ group.length / 1000 }} км{% endif %}{% if group.cp_count %}, {{ group.cp_count }} КП{% endif %}{% if group.max_time %}, Контрольное время: {{ group.max_time }} {% endif %}
            </h2>
            <div class="no-print">{{ view_groups() }}</div>
        </td>
        </tr>
        <tr>
            <td>№</td>
            <td>Фамилия, имя</td>
            <td>Коллектив</td>
            <td>Разряд</td>
            <td>ГР</td>
            <td>Номер</td>
            <td>Результат</td>
            <td>Отставание</td>
            <td>Место</td>
        </tr>
        {% set index = [1] %}
        {% for person in group.persons %}
            {% if person.relay_leg == 1 and group.type == 'RELAY' %}
                <tr>
                    <td>{{index|length}}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                {% if index.append(1) %} {% endif %} {# increment index length by 1 #}
            {% endif %}
            <tr>
                {% if group.type == 'RELAY' %}
                    <td></td>
                {% else %}
                    <td>{{ loop.index }}</td>
                {% endif %}
                <td>{{ person.name }}</td>
                <td>{{ person.team }}</td>
                <td>{{ person.qual }}</td>
                <td>{{ person.year }}</td>
                <td>{{ person.bib }}</td>
                <td>{{ person.result }}</td>
                <td>{{ person.diff }}</td>
                <td>{{ person.place }}</td>
                {% for split in person.splits %}
                    <td>
                        <small>{{ split.code }}</small><br>
                        {{ split.relative_time }}
                        {{ split.leg_time }}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        <tr style="background: white; border: 0">
            <td colspan="7" style="border: 0">
                {% if group.ranking.rank_scores and group.ranking.rank_scores > 0 %}
                    Квалификационный уровень (баллы): {{group.ranking.rank_scores}}<br>
                    Класс дистанции: {{group.ranking.max_qual}}<br>
                    {% for rank in group.ranking.rank %}
                        {{"{}".format(rank.qual)}} --
                        {% if rank.max_place %}
                            до {{rank.max_place}} места
                        {% else %}
                            {{rank.max_time}} ({{rank.percent}}%)
                        {% endif %}
                        <br>
                    {% endfor %}
                {% endif %}
            </td>
        </tr>
    {% endif %}
    {% endfor %}
    </table>
    <div>
        <table class="empty-table">
            <tr>
                <td><b>Главный судья:</b></td>
                <td width="150px"></td>
                <td><b>{{ race.chief_referee }}</b></td>
            </tr>
            <tr>
                <td><b>Главный секретарь:</b></td>
                <td width="150px"></td>
                <td><b>{{ race.secretary }}</b></td>
            </tr>
        </table>
    </div>
{% endblock %}