{% block script %}
{% raw %}
<style>
    /* SETTINGS */
    .sportorg-settings {
        position: absolute;
        border: 1px solid #dddddd;
        border-radius: 5px;
        min-width: 350px;
        background: white;
        top: 3px;
        right: 3px;
    }

    .sportorg-settings-row {
        margin: 5px;
    }

    @media print {
        .sportorg-settings {
            display: none;
        }
    }
</style>
<script>
    var TableGenerator = (function () {
        var Table = function () { return document.createElement('table') };
        var THead = function () { return document.createElement('thead') };
        var TBody = function () { return document.createElement('tbody') };
        var Tr = function () { return document.createElement('tr') };
        var Th = function () { return document.createElement('th') };
        var Td = function () { return document.createElement('td') };

        function TableGenerator(data, fields) {
            this.data = data
            this.fields = fields
        }

        TableGenerator.prototype.getTable = function (options) {
            var table = Table();
            if (options && options.className) table.className = options.className;
            table.appendChild(this.getHead());
            table.appendChild(this.getBody());
            return table;
        }

        TableGenerator.prototype.getHead = function () {
            var tr = Tr();
            for (var key of this.headers()) {
                var th = Th();
                var title = this.getHeaderName(key);
                if (title instanceof Node) {
                    th.appendChild(title);
                } else {
                    th.appendChild(document.createTextNode(title));
                }
                tr.appendChild(th);
            }
            var thead = THead();
            thead.appendChild(tr);
            return thead;
        }

        TableGenerator.prototype.getBody = function () {
            var tbody = TBody();
            var cols = this.headers().length;
            for (var obj of this.data) {
                var tr = Tr();
                if (obj instanceof Node || typeof obj === 'string') {
                    var td = Td();
                    td.colSpan = cols;
                    if (typeof obj === 'string') {
                        td.appendChild(document.createTextNode(obj));
                    } else {
                        td.appendChild(obj);
                    }
                    tr.appendChild(td);
                } else {
                    for (var key of this.headers()) {
                        var td = Td();
                        if (obj[key]) {
                            if (obj[key] instanceof Node) {
                                td.appendChild(obj[key]);
                            } else {
                                td.appendChild(document.createTextNode(obj[key]));
                            }
                        }
                        tr.appendChild(td);
                    }
                }
                tbody.appendChild(tr);
            }
            return tbody;
        }

        TableGenerator.prototype.headers = function () {
            if (this._headers) {
                return this._headers
            }
            if (!this.fields) {
                var headers = {};
                for (var obj of this.data) {
                    for (var key in obj) {
                        headers[key] = true;
                    }
                }
                this._headers = Object.keys(headers)
            } else if (this.fields instanceof Array) {
                this._headers = [];
                for (var field of this.fields) {
                    if (typeof field === 'string') {
                        this._headers.push(field);
                    } else if (field.active !== false){
                        this._headers.push(field.key);
                    }
                }
            }
            return this._headers;
        }

        TableGenerator.prototype.getHeaderName = function (key) {
            if (this.fields && this.fields instanceof Array) {
                for (var field of this.fields) {
                    if (typeof field === 'object' && field.key === key) {
                        return field.title;
                    }
                }
            }
            return key;
        }

        return TableGenerator
    }());
    var SettingsGenerator = (function () {
        var Block = function () { var el = document.createElement('div'); el.className = 'sportorg-settings'; return el };
        var Row = function () { var el = document.createElement('div'); el.className = 'sportorg-settings-row'; return el };
        function SettingsGenerator(settings) {
            this.settings = settings;
        }
        SettingsGenerator.prototype.show = function () {
            var block = Block();
            for (var setting of this.settings) {
                var row = Row();
                row.appendChild(this.getElBySetting(setting));
                block.appendChild(row);
            }
            document.body.appendChild(block);
        };
        SettingsGenerator.prototype.getElBySetting = function (setting) {
            if (typeof setting.value === 'boolean') {
                var i = document.createElement('input');
                i.type = 'checkbox';
                if (setting.value) {
                    i.checked = true;
                }
                if (setting.change) {
                    i.onchange = function () {
                        if (i.checked !== setting.value) {
                            setting.change(i.checked);
                            setting.value = i.checked;
                        }
                    }
                }
                var label = document.createElement('label');
                label.appendChild(i);
                label.appendChild(document.createTextNode(setting.title));
                return label
            } else if (setting.value instanceof Array) {
                var s = document.createElement('select');
                for (var obj of setting.value) {
                    s.appendChild(new Option(obj.text, obj.value))
                }
                if (setting.change) {
                    s.onchange = function () {
                        var results = [];
                        for (var item of s.selectedOptions) {
                            results.push(item.value)
                        }
                        setting.change(results);
                    };
                }
                var label = document.createElement('label');
                label.appendChild(document.createTextNode(setting.title));
                label.appendChild(s);
                return label
            }
        };
        return SettingsGenerator;
    }());
    function toHHMMSS (value) {
        if (!value) return '';
        value /= 1000;
        var hours = Math.floor(value / 3600);
        value %= 3600;
        var minutes = Math.floor(value / 60);
        var seconds = ~~(value % 60);
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;
        seconds = seconds < 10 ? '0' + seconds : seconds;
        return hours + ":" + minutes + ":" + seconds;
    }
    function getById (list, id) {
        if (id) {
            for (var obj of list) {
                if (obj.id === id) {
                    return obj;
                }
            }
        }
        return null;
    }
    function racePreparation(race) {
        for (var obj of race.persons) {
            obj.organization = getById(race.organizations, obj.organization_id);
            obj.group = getById(race.groups, obj.group_id);
        }
        for (var obj of race.results) {
            obj.person = getById(race.persons, obj.person_id);
        }
        for (var obj of race.groups) {
            obj.course = getById(race.courses, obj.course_id);
        }
        for (var itemName of ['groups', 'courses', 'organizations']) {
            race[itemName].sort((a, b) => {
                if (a.name.toUpperCase() < b.name.toUpperCase()) return -1;
                if (a.name.toUpperCase() > b.name.toUpperCase()) return 1;
                return 0
            })
        }
        return race;
    }
    function getGroupsBlockElement(race) {
        var groupBlock = document.createElement('div');
        groupBlock.className = 'no-print';
        for (var group of race.groups) {
            var a = document.createElement('a');
            a.href = '#' + group.name;
            a.appendChild(document.createTextNode(group.name + ' '));
            groupBlock.appendChild(a);
        }
        return groupBlock;
    }
    function dateFormat(date) {
        date = date ? new Date(date) : new Date;
        return date.getDate() + '.' + (date.getMonth() + 1) + '.' + date.getFullYear();
    }
    var Qualification = {
        '': 'б/р',
        0: 'б/р',
        3: 'IIIю',
        2: 'IIю',
        1: 'Iю',
        6: 'III',
        5: 'II',
        4: 'I',
        7: 'КМС',
        8: 'МС',
        9: 'МСМК'
    };
</script>
{% endraw %}
{% endblock %}